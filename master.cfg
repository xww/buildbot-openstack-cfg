# -*- python -*-
# ex: set syntax=python:

# This is a sample buildmaster config file. It must be installed as
# 'master.cfg' in your buildmaster's base directory.

# This is the dictionary that the buildmaster pays attention to. We also use
# a shorter alias to save typing.
c = BuildmasterConfig = {}

####### BUILDSLAVES

# The 'slaves' list defines the set of recognized buildslaves. Each element is
# a BuildSlave object, specifying a unique slave name and password.  The same
# slave name and password must be configured on the slave.
from buildbot.buildslave import BuildSlave
c['slaves'] = [BuildSlave("eva00", "eva00"),
               BuildSlave("eva01", "eva01")]

# 'slavePortnum' defines the TCP port to listen on for connections from slaves.
# This must match the value configured into the buildslaves (with their
# --master option)
c['slavePortnum'] = 9989

target_projects = {
    'havana':{
        'nova':[
            {
                'env':'it',
                'branch':'netease/havana',
                'debian_branch':'debian/havana',
                'freq':'weekly',
                'srcfolder':'nova',
                'upstream_version':'2013.2',
                'dtype':'os'
            },
            {
                'env':'st',
                'branch':'netease/havana',
                'debian_branch':'debian/havana',
                'freq':'nightly',
                'srcfolder':'nova',
                'upstream_version':'2013.2',
                'dtype':'os'
            }
        ],
    },
    'folsom':{
        'nova':[
            {
                'env':'it',
                'branch':'netease/folsom',
                'debian_branch':'debian/folsom',
                'freq':'weekly',
                'srcfolder':'nova',
                'upstream_version':'2012.2',
                'dtype':'os'
            },
            {
                'env':'st',
                'branch':'netease/folsom',
                'debian_branch':'debian/folsom',
                'freq':'nightly',
                'srcfolder':'nova',
                'upstream_version':'2012.2',
                'dtype':'os'
            }
        ],
        'glance':[
            {
                'env':'it',
                'branch':'netease/folsom',
                'debian_branch':'debian/folsom',
                'freq':'weekly',
                'srcfolder':'glance',
                'upstream_version':'2012.2',
                'dtype':'os'
            },
            {
                'env':'st',
                'branch':'netease/folsom',
                'debian_branch':'debian/folsom',
                'freq':'nightly',
                'srcfolder':'glance',
                'upstream_version':'2012.2',
                'dtype':'os'
            }
        ],
        'keystone':[
            {
                'env':'it',
                'branch':'netease/folsom',
                'debian_branch':'debian/folsom',
                'freq':'weekly',
                'srcfolder':'keystone',
                'upstream_version':'2012.2',
                'dtype':'os'
            },
            {
                'env':'st',
                'branch':'netease/folsom',
                'debian_branch':'debian/folsom',
                'freq':'nightly',
                'srcfolder':'keystone',
                'upstream_version':'2012.2',
                'dtype':'os'
            }
        ],
        'billing':[
            {
                'env':'it',
                'branch':'master',
                'debian_branch':'debian/netease',
                'freq':'weekly',
                'srcfolder':'billing',
                'dtype':'ntes'
            },
            {
                'env':'st',
                'branch':'master',
                'debian_branch':'debian/netease',
                'freq':'nightly',
                'srcfolder':'billing',
                'dtype':'ntes'
            }
        ],
        'sentry':[
            {
                'env':'it',
                'branch':'master',
                'debian_branch':'debian/netease',
                'freq':'weekly',
                'srcfolder':'sentry',
                'dtype':'ntes'
            },
            {
                'env':'st',
                'branch':'master',
                'debian_branch':'debian/netease',
                'freq':'nightly',
                'srcfolder':'sentry',
                'dtype':'ntes'
            }
        ],
        'umbrella':[
            {
                'env':'it',
                'branch':'master',
                'debian_branch':'debian/netease',
                'freq':'weekly',
                'srcfolder':'umbrella',
                'dtype':'ntes'
            },
            {
                'env':'st',
                'branch':'master',
                'debian_branch':'debian/netease',
                'freq':'nightly',
                'srcfolder':'umbrella',
                'dtype':'ntes'
            }
        ],
        'python-novaclient':[
            {
                'env':'it',
                'branch':'netease/folsom',
                'debian_branch':'debian/folsom',
                'freq':'weekly',
                'dtype':'os',
                'srcfolder':'novaclient',
                'upstream_version':'2.10.0',
                'epoch':'2'
            },
            {
                'env':'st',
                'branch':'netease/folsom',
                'debian_branch':'debian/folsom',
                'freq':'nightly',
                'dtype':'os',
                'srcfolder':'novaclient',
                'upstream_version':'2.10.0',
                'epoch':'2'
            }
        ],
        'python-glanceclient':[
            {
                'env':'it',
                'branch':'netease/folsom',
                'debian_branch':'debian/folsom',
                'freq':'weekly',
                'dtype':'os',
                'srcfolder':'glanceclient',
                'upstream_version':'0.6.0',
                'epoch':'1'
            },
            {
                'env':'st',
                'branch':'netease/folsom',
                'debian_branch':'debian/folsom',
                'freq':'nightly',
                'dtype':'os',
                'srcfolder':'glanceclient',
                'upstream_version':'0.6.0',
                'epoch':'1'
            }
        ],
        'python-keystoneclient':[
            {
                'env':'it',
                'branch':'netease/master',
                'debian_branch':'debian/netease',
                'freq':'weekly',
                'dtype':'os',
                'srcfolder':'keystoneclient',
                'upstream_version':'0.2.5',
                'epoch':'1'
            },
            {
                'env':'st',
                'branch':'netease/master',
                'debian_branch':'debian/netease',
                'freq':'nightly',
                'dtype':'os',
                'srcfolder':'keystoneclient',
                'upstream_version':'0.2.5',
                'epoch':'1'
            }
        ],
        'python-nosclient':[
            {
                'env':'it',
                'branch':'master',
                'debian_branch':'debian/netease',
                'freq':'weekly',
                'dtype':'ntes',
                'srcfolder':'nosclient'
            },
            {
                'env':'st',
                'branch':'master',
                'debian_branch':'debian/netease',
                'freq':'nightly',
                'dtype':'ntes',
                'srcfolder':'nosclient'
            }
        ],
    }
}


####### CHANGESOURCES

# the 'change_source' setting tells the buildmaster how it should find out
# about source code changes.  Here we point to the buildbot clone of pyflakes.

from buildbot.changes.gitpoller import GitPoller
c['change_source'] = []
c['change_source'].append(GitPoller(
        'ssh://SCM/openstack/nova.git',
        workdir='nova',
        project='nova',
        branches=['netease/folsom', 'netease/havana'],
        pollinterval=300))
c['change_source'].append(GitPoller(
        'ssh://SCM/openstack/glance.git',
        workdir='glance',
        project='glance',
        branch='netease/folsom',
        pollinterval=300))
c['change_source'].append(GitPoller(
        'ssh://SCM/openstack/keystone.git',
        workdir='keystone',
        project='keystone',
        branch='netease/folsom',
        pollinterval=300))
c['change_source'].append(GitPoller(
        'ssh://SCM/openstack/billing.git',
        workdir='billing',
        project='billing',
        branch='master',
        pollinterval=300))
c['change_source'].append(GitPoller(
        'ssh://SCM/openstack/postman.git',
        workdir='postman',
        project='postman',
        branch='master',
        pollinterval=300))
c['change_source'].append(GitPoller(
        'ssh://SCM/openstack/sentry.git',
        workdir='sentry',
        project='sentry',
        branch='master',
        pollinterval=300))
c['change_source'].append(GitPoller(
        'ssh://SCM/openstack/umbrella.git',
        workdir='umbrella',
        project='umbrella',
        branch='master',
        pollinterval=300))
c['change_source'].append(GitPoller(
        'ssh://SCM/openstack/python-novaclient.git',
        workdir='python-novaclient',
        project='python-novaclient',
        branch='netease/folsom',
        pollinterval=300))
c['change_source'].append(GitPoller(
        'ssh://SCM/openstack/python-glanceclient.git',
        workdir='python-glanceclient',
        project='python-glanceclient',
        branch='netease/folsom',
        pollinterval=300))
c['change_source'].append(GitPoller(
        'ssh://SCM/openstack/python-keystoneclient.git',
        workdir='python-keystoneclient',
        project='python-keystoneclient',
        branch='netease/master',
        pollinterval=300))
c['change_source'].append(GitPoller(
        'ssh://SCM/openstack/python-nosclient.git',
        workdir='python-nosclient',
        project='python-nosclient',
        branch='master',
        pollinterval=300))


####### SCHEDULERS

# Configure the Schedulers, which decide how to react to incoming changes.  In this
# case, just kick off a 'runtests' build

import re

from buildbot.schedulers.basic import SingleBranchScheduler
from buildbot.schedulers.timed import Nightly
from buildbot.schedulers.forcesched import ForceScheduler
from buildbot.scheduler import Try_Userpass
from buildbot.changes import filter


def is_nt_version_changed(change):
    for f in change.files:
        match = re.match(".+\/nt_version.py$", f)

        if match:
            return True

    return False


c['schedulers'] = []
#c['schedulers'].append(SingleBranchScheduler(
#                            name="all",
#                            change_filter=filter.ChangeFilter(branch='netease/folsom'),
#                            treeStableTimer=None,
#                            builderNames=["build-nova"]))
#c['schedulers'].append(Try_Userpass(
#                            name='nova-try',
#                            change_filter=filter.ChangeFilter(
#                                project='nova',
#                                branch='netease/folsom'),
#                            builderNames=['build-nova'],
#                            port=5555,
#                            userpass=[('nova', 'nova')]))

def add_st_scheduler(c, project, branch, codename):
    c['schedulers'].append(Nightly(
                                name=project+'-'+codename+'-nightly-st',
                                branch=branch,
                                builderNames=[
                                    'build-'+project+'-'+codename+'-st'],
                                change_filter=filter.ChangeFilter(
                                    project=project,
                                    branch=branch),
                                hour=2,
                                minute=34,
                                onlyIfChanged=True))
    c['schedulers'].append(ForceScheduler(
                                name=project+'-'+codename+'-force-st',
                                builderNames=[
                                    'build-'+project+'-'+codename+'-st']))


def add_it_scheduler(c, project, branch, codename):
    c['schedulers'].append(SingleBranchScheduler(
                                name=project+'-'+codename+'-weekly-it',
                                change_filter=filter.ChangeFilter(
                                    project=project,
                                    branch=branch),
                                fileIsImportant=is_nt_version_changed,
                                treeStableTimer=120,
                                builderNames=[
                                    'build-'+project+'-'+codename+'-it']))
    c['schedulers'].append(ForceScheduler(
                                name=project+'-'+codename+'-force-it',
                                builderNames=[
                                    'build-'+project+'-'+codename+'-it']))

# add schedulers
funcs = globals().copy()
funcs.update(locals())

for n, t in target_projects.iteritems():
    for k, v in t.iteritems():
        for e in v:
            funcs['add_'+e['env']+'_scheduler'](c, k, e['branch'], n)


####### BUILDERS

# The 'builders' list defines the Builders, which tell Buildbot how to perform a build:
# what steps, and which slaves can execute them.  Note that any particular build will
# only take place on one slave.

from buildbot.process.factory import BuildFactory
from buildbot.steps.source.git import Git
from buildbot.steps.shell import ShellCommand
from buildbot.steps.transfer import FileUpload
from buildbot.steps.master import MasterShellCommand


# init build factories
for n, t in target_projects.iteritems():
    for k, v in t.iteritems():
        for e in v:
            locals()[k+'_'+n+'_'+e['env']+'_factory'] = BuildFactory()


def add_build_step(factory, project, branch, debian_branch, version, freq,
                   codename):
    factory.addStep(ShellCommand(command=["rm", "-rf", project], workdir='build'))
    factory.addStep(ShellCommand(command=["rm", "-rf", "build-area"], workdir='build'))
    factory.addStep(Git(repourl='ssh://SCM/openstack/'+project+'.git', mode='full', method='clobber', workdir='build/'+project))

    factory.addStep(ShellCommand(command=["git", "checkout", "-b", branch+"-"+freq, "origin/"+branch], workdir='build/'+project))
    factory.addStep(ShellCommand(command=["git", "checkout", "-b", "debian/"+freq+"-build", "origin/"+debian_branch], workdir='build/'+project))
    factory.addStep(ShellCommand(command=["git", "merge", branch+"-"+freq, "--no-edit", "--stat"], workdir='build/'+project))
    factory.addStep(ShellCommand(command=["git", "dch", "--debian-branch", "debian/"+freq+"-build", "--git-log", "--author stanzgy",
                                          "--new-version", version], workdir='build/'+project))
    factory.addStep(ShellCommand(command=["sed", "-e", "s/UNRELEASED/wheezy-"+freq+"/", "debian/changelog"], workdir='build/'+project))
    factory.addStep(ShellCommand(command=["git", "commit", "-a", "-m", "auto build"], workdir='build/'+project))
    factory.addStep(ShellCommand(command=["git-pbuilder", "update"], workdir='build/'+project, env={"DIST":"wheezy", "ARCH":"amd64"}))
    factory.addStep(ShellCommand(command=["git-buildpackage", "--git-dist=wheezy", "--git-arch=amd64", "--git-pbuilder",
                                          "--git-pbuilder-options=--allow-untrusted",
                                          "--git-cleaner=/bin/true",
                                          "--git-debian-branch=debian/"+freq+"-build",
                                          "--git-upstream-branch="+branch+"-"+freq, "--git-upstream-tree=branch", "-nc"], workdir='build/'+project))
    factory.addStep(ShellCommand(command=["tar", "cJf", project+"-"+codename+"-"+freq+".tar.xz", "."], workdir='build/build-area'))
    factory.addStep(FileUpload(slavesrc=project+"-"+codename+"-"+freq+".tar.xz",
                               masterdest="~/workspace/buildbot/temp/"+project+"-"+codename+"-"+freq+".new.tar.xz", mode=0644,
                               workdir="build/build-area"))
    factory.addStep(MasterShellCommand(command="""
set -e
dname="%(project)s-%(codename)s-%(freq)s.$(date +%%Y%%m%%dT%%H%%M)"
mkdir -p /home/debian/archives/%(freq)s/%(project)s
cd /home/debian/archives/%(freq)s/%(project)s
cp ~/workspace/buildbot/temp/%(project)s-%(codename)s-%(freq)s.new.tar.xz $dname.tar.xz
mkdir -p $dname
tar xJf $dname.tar.xz -C $dname
cd $dname
reprepro -b /home/debian/reprepro removesrc wheezy-%(codename)s-%(freq)s %(project)s
reprepro -b /home/debian/reprepro --ignore=wrongdistribution include wheezy-%(codename)s-%(freq)s %(project)s_*.changes
""" % locals()))
    #factory.addStep(MasterShellCommand(command="""
    #cd /home/debian/nightly/archives
    #ls -lt|tail -n +2|head -n 2|awk '{if($9 ~ /.*\.tar\.xz/) system("chmod +r " $9); else if($1 ~ /^d/) {system("chmod -R +r " $9);system("chmod +x " $9)}}'
    #"""))

os_st_version = "netease.`date +%%Y%%m%%dT%%H%%M`.git`git rev-parse --short HEAD`.nightly-1"
os_it_version = 'netease.`find %(srcfolder)s -type f -name nt_version.py -exec sed -rn "s/.*([0-9]+\\.[0-9]+\\.[0-9]+).*/\\1/p" {} \+`.git`git rev-parse --short HEAD`.weekly-1'
ntes_st_version = "`date +%%Y%%m%%dT%%H%%M`.git`git rev-parse --short HEAD`.nightly-1"
ntes_it_version = '`find %(srcfolder)s -type f -name nt_version.py -exec sed -rn "s/.*([0-9]+\\.[0-9]+\\.[0-9]+).*/\\1/p" {} \+`.weekly-1'

for n, t in target_projects.iteritems():
    for k, v in t.iteritems():
        for e in v:
            ver = locals()[e['dtype']+'_'+e['env']+'_version'] % {'srcfolder':e['srcfolder']}

            upver = e.get('upstream_version')
            if upver:
                ver = upver + '+' + ver

            epoch = e.get('epoch')
            if epoch:
                ver = epoch + ':' + ver

            add_build_step(locals()[k+'_'+n+'_'+e['env']+'_factory'], k,
                           e['branch'], e['debian_branch'], ver, e['freq'], n)


from buildbot.config import BuilderConfig

c['builders'] = []
for n, t in target_projects.iteritems():
    for k, v in t.iteritems():
        for e in v:
            c['builders'].append(
                BuilderConfig(name='build-'+k+'-'+n+'-'+e['env'],
                    slavenames=['eva00'],
                    factory=locals()[k+'_'+n+'_'+e['env']+'_factory']))


####### STATUS TARGETS

# 'status' is a list of Status Targets. The results of each build will be
# pushed to these targets. buildbot/status/*.py has a variety to choose from,
# including web pages, email senders, and IRC bots.

c['status'] = []

from buildbot.status import html
from buildbot.status.web import authz, auth

authz_cfg=authz.Authz(
    # change any of these to True to enable; see the manual for more
    # options
    auth=auth.BasicAuth([("admin","nimda")]),
    gracefulShutdown = True,
    forceBuild = 'auth', # use this to test your slave once it is set up
    forceAllBuilds = True,
    pingBuilder = True,
    stopBuild = True,
    stopAllBuilds = True,
    cancelPendingBuild = True,
)
c['status'].append(html.WebStatus(http_port=8088, authz=authz_cfg))

####### PROJECT IDENTITY

# the 'title' string will appear at the top of this buildbot
# installation's html.WebStatus home page (linked to the

c['title'] = "NetEase Openstack"
c['titleURL'] = "https://scm.hz.netease.com"

# the 'buildbotURL' string should point to the location where the buildbot's
# internal web server (usually the html.WebStatus page) is visible. This
# typically uses the port number set in the Waterfall 'status' entry, but
# with an externally-visible host name which the buildbot cannot figure out
# without some help.

c['buildbotURL'] = "http://114.113.199.8:8088/"

####### DB URL

c['db'] = {
    # This specifies what database buildbot uses to store its state.  You can leave
    # this at its default for all but the largest installations.
    'db_url' : "sqlite:///state.sqlite",
}

####### MAIL NOTIFIER
from buildbot.status.mail import MailNotifier
from buildbot.status.builder import Results

def messageFormatter(mode, name, build, results, master_status):
    result = Results[results]

    text = list()
    text.append("BUILD STATUS: %s" % result.title())
    #text.append("Buildslave for this build: %s" % build.getSlavename())
    text.append("Build reason: %s" % build.getReason())
    if master_status.getURLForThing(build):
        text.append("Complete logs for build steps: %s" %
                        master_status.getURLForThing(build))
    return {
        'body' : "\n".join(text),
        'type' : 'plain'
    }

mn = MailNotifier(fromaddr="buildbot_os@163.com",
                  sendToInterestedUsers=False,
                  #mode="all",
                  mode="problem",
                  #subject="buildbot %(result)s on %(builder)s",
                  subject="%(result)s on %(builder)s",
                  extraRecipients=["nvs@hz.netease.com",
                                   "hzzhanggy@corp.netease.com"],
                  relayhost="smtp.163.com", smtpPort=25, useTls=True,
                  smtpUser="buildbot_os@163.com", smtpPassword="qwerty",
                  messageFormatter=messageFormatter,
                  extraHeaders={"Return-Path": "stan.zgy@gmail.com"})

c['status'].append(mn)

