# -*- python -*-
# ex: set syntax=python:

import os

# This is a sample buildmaster config file. It must be installed as
# 'master.cfg' in your buildmaster's base directory.

# This is the dictionary that the buildmaster pays attention to. We also use
# a shorter alias to save typing.
c = BuildmasterConfig = {}

####### BUILDSLAVES

# The 'slaves' list defines the set of recognized buildslaves. Each element is
# a BuildSlave object, specifying a unique slave name and password.  The same
# slave name and password must be configured on the slave.
from buildbot.buildslave import BuildSlave
c['slaves'] = [BuildSlave("alice", "alice")]

slaves_env = {'havana': ['alice']}

# 'slavePortnum' defines the TCP port to listen on for connections from slaves.
# This must match the value configured into the buildslaves (with their
# --master option)
c['slavePortnum'] = 9989


# build options
BUILDBOT_WEB_ADDR = os.environ['BUILDBOT_WEB_ADDR']
BUILDBOT_WEB_PORT = 8088

BUILDBOT_TITLE = 'NetEase Openstack'
BUILDBOT_TITLE_URL = os.environ['BUILDBOT_TITLE_URL']

BUILDER_PREFIX = 'build'
BUILDER_SRC_BRANCH = 'src'
BUILDER_DEBIAN_BRANCH = 'debian/autobuild'
BUILDER_EXPORT_DIR = 'build-area'

REPREPRO_DIR = '/home/debian/reprepro'
ARCHIVE_DIR = '/home/debian/archive'
ARCHIVE_MODE = 0644

DEFAULT_DIST = 'wheezy'
DEFAULT_ARCH = 'amd64'
PBUILDER_OPTIONS = "--allow-untrusted"
CLEANER = "/bin/true"

MAIL_ADDR = os.environ['BUILDBOT_MAIL_ADDR']
MAIL_USER = os.environ['BUILDBOT_MAIL_USER']
MAIL_SMTP_SERVER = 'smtp.163.com'
MAIL_SMTP_PORT = 25
MAIL_USE_TLS = False
MAIL_RECIPIENTS = ["hzzhanggy@corp.netease.com"]
MAIL_RECIPIENTS.extend(["nvs@hz.netease.com", "cns@hz.netease.com"])
MAIL_LOG_LAST_LINES = 80

immediate_version = r'git describe | sed -r "s/(.*)-(.*)-(.*)/\1+netease.\2.\3/"'
nightly_version = r'git describe | sed -r "s/(.*)-(.*)-(.*)/\1+netease.\2.\3.nightly/"'
release_version = r'git describe --tags --abbrev=0'


# build settings
class Env:
    ST = 'dev'
    IT = 'int'
    RC = 'rc'
    RC_A = 'rc_a'
    RC_B = 'rc_b'
    RC_P = 'rc_p'


class Trigger:
    IMMEDIATE = 'immediate'
    NIGHTLY = 'nightly'
    RELEASE = 'release'


class ProjectType:
    NETEASE = 'ntes'
    OPENSTACK = 'os'


target_projects = {
    'havana': {
        # Openstack projects
        'nova': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/nova.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'src_folder': 'nova',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/nova.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-testing',
                'src_folder': 'nova',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/nova.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-rc',
                'src_folder': 'nova',
            },
            {
                'env': Env.RC_A,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/nova.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-a-rc',
                'src_folder': 'nova',
            },
            {
                'env': Env.RC_B,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/nova.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-b-rc',
                'src_folder': 'nova',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/nova.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-p-rc',
                'src_folder': 'nova',
            },
        ],
        'neutron': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/neutron.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'src_folder': 'neutron',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/neutron.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-testing',
                'src_folder': 'neutron',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/neutron.git',
                'code_branch': 'netease/havana-release',
                'debian_branch': 'debian/havana-release',
                'debian_repo': 'wheezy-havana-rc',
                'src_folder': 'neutron',
            },
            {
                'env': Env.RC_A,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/neutron.git',
                'code_branch': 'netease/havana-release',
                'debian_branch': 'debian/havana-release',
                'debian_repo': 'wheezy-havana-a-rc',
                'src_folder': 'neutron',
            },
            {
                'env': Env.RC_B,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/neutron.git',
                'code_branch': 'netease/havana-release',
                'debian_branch': 'debian/havana-release',
                'debian_repo': 'wheezy-havana-b-rc',
                'src_folder': 'neutron',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/neutron.git',
                'code_branch': 'netease/havana-release',
                'debian_branch': 'debian/havana-release',
                'debian_repo': 'wheezy-havana-p-rc',
                'src_folder': 'neutron',
            },
        ],
        'glance': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/glance.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'src_folder': 'glance',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/glance.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-testing',
                'src_folder': 'glance',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/glance.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-rc',
                'src_folder': 'glance',
            },
            {
                'env': Env.RC_A,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/glance.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-a-rc',
                'src_folder': 'glance',
            },
            {
                'env': Env.RC_B,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/glance.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-b-rc',
                'src_folder': 'glance',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/glance.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-p-rc',
                'src_folder': 'glance',
            },
        ],
        'keystone': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/keystone.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'src_folder': 'keystone',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/keystone.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-testing',
                'src_folder': 'keystone',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/keystone.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-rc',
                'src_folder': 'keystone',
            },
            {
                'env': Env.RC_A,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/keystone.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-a-rc',
                'src_folder': 'keystone',
            },
            {
                'env': Env.RC_B,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/keystone.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-b-rc',
                'src_folder': 'keystone',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/keystone.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-p-rc',
                'src_folder': 'keystone',
            },
        ],
        'cinder': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/cinder.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'src_folder': 'cinder',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/cinder.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-testing',
                'src_folder': 'cinder',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/cinder.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-rc',
                'src_folder': 'cinder',
            },
            {
                'env': Env.RC_A,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/cinder.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-a-rc',
                'src_folder': 'cinder',
            },
            {
                'env': Env.RC_B,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/cinder.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-b-rc',
                'src_folder': 'cinder',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/cinder.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-p-rc',
                'src_folder': 'cinder',
            },
        ],
        'python-novaclient': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-novaclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'epoch': 2,
                'src_folder': 'python-novaclient',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-novaclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-testing',
                'epoch': 2,
                'src_folder': 'python-novaclient',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-novaclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-rc',
                'epoch': 2,
                'src_folder': 'python-novaclient',
            },
            {
                'env': Env.RC_A,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-novaclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-a-rc',
                'epoch': 2,
                'src_folder': 'python-novaclient',
            },
            {
                'env': Env.RC_B,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-novaclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-b-rc',
                'epoch': 2,
                'src_folder': 'python-novaclient',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-novaclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-p-rc',
                'epoch': 2,
                'src_folder': 'python-novaclient',
            },
        ],
        'python-neutronclient': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-neutronclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'src_folder': 'python-neutronclient',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-neutronclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-testing',
                'src_folder': 'python-neutronclient',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-neutronclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-rc',
                'src_folder': 'python-neutronclient',
            },
            {
                'env': Env.RC_A,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-neutronclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-a-rc',
                'src_folder': 'python-neutronclient',
            },
            {
                'env': Env.RC_B,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-neutronclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-b-rc',
                'src_folder': 'python-neutronclient',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-neutronclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-p-rc',
                'src_folder': 'python-neutronclient',
            },
        ],
        'python-keystoneclient': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-keystoneclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'epoch': 1,
                'src_folder': 'python-keystoneclient',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-keystoneclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-testing',
                'epoch': 1,
                'src_folder': 'python-keystoneclient',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-keystoneclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-rc',
                'epoch': 1,
                'src_folder': 'python-keystoneclient',
            },
            {
                'env': Env.RC_A,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-keystoneclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-a-rc',
                'epoch': 1,
                'src_folder': 'python-keystoneclient',
            },
            {
                'env': Env.RC_B,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-keystoneclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-b-rc',
                'epoch': 1,
                'src_folder': 'python-keystoneclient',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-keystoneclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-p-rc',
                'epoch': 1,
                'src_folder': 'python-keystoneclient',
            },
        ],

        # NetEase projects
        'umbrella': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/umbrella.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'src_folder': 'umbrella',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/umbrella.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-testing',
                'src_folder': 'umbrella',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/umbrella.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-rc',
                'src_folder': 'umbrella',
            },
            {
                'env': Env.RC_A,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/umbrella.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-a-rc',
                'src_folder': 'umbrella',
            },
            {
                'env': Env.RC_B,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/umbrella.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-b-rc',
                'src_folder': 'umbrella',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/umbrella.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-p-rc',
                'src_folder': 'umbrella',
            },
        ],
        'sentry': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/sentry.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'src_folder': 'sentry',
            },
        ],
    },
}


####### CHANGESOURCES

# the 'change_source' setting tells the buildmaster how it should find out
# about source code changes.  Here we point to the buildbot clone of pyflakes.

from buildbot.changes.gitpoller import GitPoller

c['change_source'] = []

# Openstack projects
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/nova.git',
    workdir='nova',
    project='nova',
    branches=['netease/havana', 'netease/havana-stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/neutron.git',
    workdir='neutron',
    project='neutron',
    branches=['netease/havana', 'netease/havana-stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/glance.git',
    workdir='glance',
    project='glance',
    branches=['netease/havana', 'netease/havana-stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/keystone.git',
    workdir='keystone',
    project='keystone',
    branches=['netease/havana', 'netease/havana-stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/cinder.git',
    workdir='cinder',
    project='cinder',
    branches=['netease/havana', 'netease/havana-stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/python-novaclient.git',
    workdir='python-novaclient',
    project='python-novaclient',
    branches=['netease/master', 'netease/havana'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/python-glanceclient.git',
    workdir='python-glanceclient',
    project='python-glanceclient',
    branches=['netease/master', 'netease/havana'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/python-keystoneclient.git',
    workdir='python-keystoneclient',
    project='python-keystoneclient',
    branches=['netease/master', 'netease/havana'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/python-neutronclient.git',
    workdir='python-neutronclient',
    project='python-neutronclient',
    branches=['netease/master', 'netease/havana'],
    pollinterval=300))

# NetEase projects
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/billing.git',
    workdir='billing',
    project='billing',
    branches=['master', 'stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/sentry.git',
    workdir='sentry',
    project='sentry',
    branches=['netease/havana'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/umbrella.git',
    workdir='umbrella',
    project='umbrella',
    branches=['netease/havana', 'netease/havana-stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/monitor.git',
    workdir='monitor',
    project='monitor',
    branches=['master', 'stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/python-nosclient.git',
    workdir='python-nosclient',
    project='python-nosclient',
    branches=['master', 'stable'],
    pollinterval=300))


####### SCHEDULERS

import re

from buildbot.schedulers.basic import SingleBranchScheduler
from buildbot.schedulers.timed import Nightly
from buildbot.schedulers.forcesched import ForceScheduler
from buildbot.scheduler import Try_Userpass
from buildbot.changes import filter


c['schedulers'] = []


def add_scheduler(c, project, branch, codename, env):
    import random

    m = random.randint(0, 59)
    if env == Env.ST:
        c['schedulers'].append(SingleBranchScheduler(
            name='-'.join([project, codename, env]),
            change_filter=filter.ChangeFilter(
                project=project,
                branch=branch),
            builderNames=[
                '-'.join([BUILDER_PREFIX, project,
                          codename, env])],
            treeStableTimer=120))
        c['schedulers'].append(ForceScheduler(
            name='-'.join([project, codename,
                           'force', env]),
            builderNames=[
                '-'.join([BUILDER_PREFIX, project,
                          codename, env])]))
    elif env == Env.IT:
        c['schedulers'].append(Nightly(
            name='-'.join([project, codename, env]),
            branch=branch,
            change_filter=filter.ChangeFilter(
                project=project,
                branch=branch),
            builderNames=[
                '-'.join([BUILDER_PREFIX, project,
                          codename, env])],
            hour=2,
            minute=m,
            onlyIfChanged=True))
        c['schedulers'].append(ForceScheduler(
            name='-'.join([project, codename,
                           'force', env]),
            builderNames=[
                '-'.join([BUILDER_PREFIX, project,
                          codename, env])]))
    elif env in (Env.RC, Env.RC_A, Env.RC_B, Env.RC_P):
        c['schedulers'].append(ForceScheduler(
            name='-'.join([project, codename,
                           'force', env]),
            builderNames=[
                '-'.join([BUILDER_PREFIX, project,
                          codename, env])]))
    else:
        raise Exception("undefined environment")


# add schedulers
for codename, targets in target_projects.iteritems():
    for project, builds in targets.iteritems():
        for build in builds:
            add_scheduler(c, project, build['code_branch'],
                          codename, build['env'])


####### BUILDERS

from buildbot.process.factory import BuildFactory
from buildbot.process.properties import Interpolate
from buildbot.steps.master import MasterShellCommand
from buildbot.steps.shell import SetPropertyFromCommand
from buildbot.steps.shell import ShellCommand
from buildbot.steps.source.git import Git
from buildbot.steps.transfer import FileUpload


# init build factories
for codename, targets in target_projects.iteritems():
    for project, builds in targets.iteritems():
        for build in builds:
            locals()['_'.join([project, codename,
                               build['env'], 'factory'])] = BuildFactory()


# define build steps
def add_build_step(factory, build_kwargs):
    # init build args
    project = build_kwargs['project']
    codename = build_kwargs['codename']
    repo_url = build_kwargs['repo_url']
    env = build_kwargs['env']
    trigger = build_kwargs['trigger']
    code_branch = build_kwargs['code_branch']
    debian_branch = build_kwargs['debian_branch']
    debian_repo = build_kwargs['debian_repo']
    upstream_version = build_kwargs['upstream_version']
    debian_version = build_kwargs['debian_version']
    epoch = build_kwargs['epoch']
    dist = build_kwargs['dist']
    arch = build_kwargs['arch']

    # clone git repo
    factory.addStep(Git(repourl=repo_url,
                        mode='full', method='clobber',
                        workdir='build/%s' % project,
                        progress=False,
                        retryFetch=True,
                        haltOnFailure=True,
                        logEnviron=False))

    # make sure code branch and debian branch are correct
    factory.addStep(ShellCommand(
        name="ensure debian branch",
        command=['git', 'checkout', 'origin/%s' % debian_branch],
        haltOnFailure=True,
        workdir='build/%s' % project,
        logEnviron=False))
    factory.addStep(ShellCommand(
        name="ensure src branch",
        command=['git', 'checkout', 'origin/%s' % code_branch],
        haltOnFailure=True,
        workdir='build/%s' % project,
        logEnviron=False))

    # prepare auto build  debian branch
    factory.addStep(ShellCommand(
        name="checkout src local branch",
        command=('git checkout -b %(src_branch)s $(%(version)s) || '
                 '(git checkout -b %(src_branch)s origin/%(code_branch)s && '
                 'git tag $(%(version)s))' %
                    {'src_branch': BUILDER_SRC_BRANCH,
                     'version': upstream_version,
                     'code_branch': code_branch}),
        workdir='build/%s' % project,
        logEnviron=False))
    factory.addStep(SetPropertyFromCommand(
        command=['git', 'describe', '--tags'],
        property='git_version',
        workdir='build/%s' % project,
        logEnviron=False))
    factory.addStep(ShellCommand(
        name="checkout debian local branch",
        command=['git', 'checkout', '-b',
                 BUILDER_DEBIAN_BRANCH, 'origin/%s' % debian_branch],
        workdir='build/%s' % project,
        logEnviron=False))
    factory.addStep(ShellCommand(
        name="merge src branch",
        command=['git', 'merge',
                 BUILDER_SRC_BRANCH,
                 '--no-edit', '--stat'],
        haltOnFailure=True,
        workdir='build/%s' % project,
        logEnviron=False))

    # generate changelog
    e = ''
    if epoch:
        e = str(epoch) + ':'

    factory.addStep(ShellCommand(
        name="generate debian changelog",
        command=['git', 'dch',
                 '--debian-branch', BUILDER_DEBIAN_BRANCH,
                 '--git-author',
                 '--new-version', Interpolate(e+'%(prop:git_version)s-'+
                                              debian_version)],
        workdir='build/%s' % project,
        warnOnWarnings=True,
        haltOnFailure=True,
        logEnviron=False))
    factory.addStep(ShellCommand(
        name="update package debian repo",
        command=['sed', '-i',
                 's/UNRELEASED/'+debian_repo+'/',
                 'debian/changelog'],
        workdir='build/%s' % project,
        logEnviron=False))
    factory.addStep(ShellCommand(
        name="commit changes for packaging",
        command=['git', 'commit', '-a', '-m', 'buildbot auto build'],
        workdir='build/%s' % project,
        logEnviron=False))

    # build the package
    factory.addStep(ShellCommand(
        name="pbuilder update",
        command=['git-pbuilder', 'update'],
        env={'DIST': dist, 'ARCH': arch},
        workdir='build/%s' % project,
        haltOnFailure=True,
        logEnviron=False))
    factory.addStep(ShellCommand(
        name="build everything",
        command=['git-buildpackage',
                 '--git-dist=%s' % dist,
                 '--git-arch=%s' % arch,
                 '--git-pbuilder',
                 '--git-pbuilder-options=%s' % PBUILDER_OPTIONS,
                 '--git-cleaner=%s' % CLEANER,
                 '--git-upstream-branch=%s' % BUILDER_SRC_BRANCH,
                 '--git-debian-branch=%s' % BUILDER_DEBIAN_BRANCH,
                 '--git-upstream-tree=branch',
                 '--git-export-dir=../%s' % BUILDER_EXPORT_DIR,
                 '-nc'],
        workdir='build/%s' % project,
        haltOnFailure=True,
        warnOnWarnings=True,
        logEnviron=False))

    # get package version
    factory.addStep(SetPropertyFromCommand(
        command=(r'head -n 1 debian/changelog | sed -r "s/.+\((.+)\).+/\1/"'),
        property='package_version_epoch',
        workdir='build/%s' % project,
        logEnviron=False))
    factory.addStep(SetPropertyFromCommand(
        command=(r'head -n 1 debian/changelog | sed -r "s/.+\((.+)\).+/\1/" | '
                  'sed  "s/.*\://g"'),
        property='package_version',
        workdir='build/%s' % project,
        logEnviron=False))

    # clean build export folder
    factory.addStep(ShellCommand(
        name="clean build export folder",
        command=['rm', '-rf', '*.obsolete.*'],
        workdir='build/%s' % BUILDER_EXPORT_DIR,
        logEnviron=False))

    # upload archive to master
    factory.addStep(ShellCommand(
        name="package build exports",
        command=['/bin/sh', '-c',
                 Interpolate('tar cJf %(project)s_%(version)s.tar.xz '
                             '--exclude=%(project)s_%(version)s.tar.xz '
                             '*%(git_version)s*' %
                             {'project': project,
                              'version': '%(prop:package_version)s',
                              'git_version': '%(prop:git_version)s'})],
        workdir='build/%s' % BUILDER_EXPORT_DIR,
        haltOnFailure=True,
        logEnviron=False))
    factory.addStep(FileUpload(
        slavesrc= Interpolate('%(project)s_%(version)s.tar.xz' %
                              {'project': project,
                               'version': '%(prop:package_version)s'}),
        masterdest=(Interpolate(ARCHIVE_DIR+'/%(env)s/%(project)s/%(version)s/'
                                '%(project)s_%(version)s.tar.xz' %
                                {'env': env,
                                 'project': project,
                                 'trigger': trigger,
                                 'version': '%(prop:package_version)s'})),
        mode=ARCHIVE_MODE,
        workdir='build/%s' % BUILDER_EXPORT_DIR))

    # add package to deb source
    factory.addStep(MasterShellCommand(
        name="reprepro import packages",
        command=Interpolate(
"""cd %(archive_dir)s/%(env)s/%(project)s/%(version)s
tar xJf %(project)s_%(version)s.tar.xz
reprepro -b %(reprepro_dir)s --ignore=wrongdistribution --ignore=missingfile \
include %(debian_repo)s *%(version)s*.changes""" %
            {'project': project,
             'env': env,
             'version': '%(prop:package_version)s',
             'reprepro_dir': REPREPRO_DIR,
             'archive_dir': ARCHIVE_DIR,
             'debian_repo': debian_repo}),
        haltOnFailure=False,
        env={}))


# add builder factory buildsteps
for codename, targets in target_projects.iteritems():
    for project, builds in targets.iteritems():
        for build in builds:
            build_kwargs = {
                'project': project,
                'codename': codename,
                'repo_url': build['repo_url'],
                'env': build['env'],
                'trigger': build['trigger'],
                'code_branch': build['code_branch'],
                'debian_branch': build['debian_branch'],
                'debian_repo': build['debian_repo']
            }

            if build['trigger'] == Trigger.IMMEDIATE:
                upstream_version = immediate_version
            elif build['trigger'] == Trigger.NIGHTLY:
                upstream_version = nightly_version
            elif build['trigger'] == Trigger.RELEASE:
                upstream_version = release_version
            else:
                raise Exception("undefined trigger")

            epoch = build.get('epoch')
            if epoch:
                epoch = epoch

            debian_version = build.get('debian_version')
            if debian_version:
                debian_version = debian_version
            else:
                debian_version = '1'

            build_kwargs['upstream_version'] = upstream_version
            build_kwargs['debian_version'] = debian_version
            build_kwargs['epoch'] = epoch

            dist = build.get('dist')
            if dist:
                build_kwargs['dist'] = dist
            else:
                build_kwargs['dist'] = DEFAULT_DIST

            arch = build.get('arch')
            if arch:
                build_kwargs['arch'] = arch
            else:
                build_kwargs['arch'] = DEFAULT_ARCH

            add_build_step(factory = locals()['_'.join(
                                                [project, codename,
                                                 build['env'], 'factory'])],
                           build_kwargs = build_kwargs)



# init builder configs
from buildbot.config import BuilderConfig

c['builders'] = []
for codename, targets in target_projects.iteritems():
    for project, builds in targets.iteritems():
        for build in builds:
            c['builders'].append(
                BuilderConfig(
                    name='-'.join([BUILDER_PREFIX, project,
                                   codename, build['env']]),
                    slavenames=slaves_env[codename],
                    factory=locals()['_'.join([project, codename,
                                               build['env'], 'factory'])]))


####### STATUS TARGETS

# 'status' is a list of Status Targets. The results of each build will be
# pushed to these targets. buildbot/status/*.py has a variety to choose from,
# including web pages, email senders, and IRC bots.

c['status'] = []

from buildbot.status import html
from buildbot.status.web import authz, auth

authz_cfg=authz.Authz(
    # change any of these to True to enable; see the manual for more
    # options
    auth=auth.BasicAuth([("admin", os.environ['BUILDBOT_ADMIN_PASSWD'])]),
    gracefulShutdown = True,
    forceBuild = False,
    forceAllBuilds = False,
    pingBuilder = True,
    stopBuild = True,
    stopAllBuilds = False,
    cancelPendingBuild = True,
)
c['status'].append(html.WebStatus(http_port=BUILDBOT_WEB_PORT,
                                  authz=authz_cfg))


####### PROJECT IDENTITY

# the 'title' string will appear at the top of this buildbot
# installation's html.WebStatus home page (linked to the

c['title'] = BUILDBOT_TITLE
c['titleURL'] = BUILDBOT_TITLE_URL

# the 'buildbotURL' string should point to the location where the buildbot's
# internal web server (usually the html.WebStatus page) is visible. This
# typically uses the port number set in the Waterfall 'status' entry, but
# with an externally-visible host name which the buildbot cannot figure out
# without some help.

c['buildbotURL'] = ("http://%(server)s:%(port)d/" %
                        {'server': BUILDBOT_WEB_ADDR,
                         'port': BUILDBOT_WEB_PORT})


####### DB URL

c['db'] = {
    # This specifies what database buildbot uses to store its state.  You can leave
    # this at its default for all but the largest installations.
    'db_url': "sqlite:///state.sqlite",
}


####### MAIL NOTIFIER

import cgi
import datetime

from buildbot.status.mail import MailNotifier
from buildbot.status.builder import Results
from buildbot.status.results import SUCCESS

def messageFormatter(mode, name, build, results, master_status):
    result = Results[results]

    # Build Info
    text = list()
    text.append(u"<h4>Build status: %s</h4>" % result.title())
    text.append(u'<table cellspacing="10">')
    text.append(u"<tr><td>Build reason:</td><td>%s</td></tr>" %
                cgi.escape(build.getReason()))
    text.append(u"<tr><td>Buildslave for this build:</td><td>%s</td></tr>" %
                build.getSlavename())

    responsible_users = ",".join(build.getResponsibleUsers())
    if responsible_users:
        text.append(u"<tr><td>Build Responsible Users:</td><td>%s</td></tr>" %
                    cgi.escape(responsible_users))

    for ss in build.getSourceStamps():
        source = u""
        if ss.codebase:
            source += u'%s: ' % ss.codebase
        if ss.branch:
            source += u"[branch %s] " % ss.branch
        if ss.revision:
            source +=  ss.revision
        else:
            source += u"HEAD"
        if ss.patch:
            source += u" (plus patch)"
        if ss.patch_info: # add patch comment
            source += u" (%s)" % ss.patch_info[1]

    text.append(u"<tr><td>Build Source Stamp:</td><td>%s</td></tr>" % source)

    build_url = master_status.getURLForThing(build)
    if build_url:
        text.append(u"<tr><td>Complete logs for build steps:</td>"
                     "<td><a href='%s'>%s</a></td></tr>" %
                     (build_url, build_url))

    text.append(u'</table>')
    text.append("<br />")

    # Recent Changes
    if ss.changes:
        i = 1
        text.append(u'<h4>Recent Changes:</h4>')
        for c in ss.changes:
            cd = c.asDict()
            when = datetime.datetime.fromtimestamp(cd['when']).ctime()

            text.append(u'<h5>change #%d</h5>' % i)
            text.append(u'<table cellspacing="10">')
            text.append(u'<tr><td>Repository:</td><td>%s</td></tr>' %
                        cd['repository'])
            text.append(u'<tr><td>Project:</td><td>%s</td></tr>' %
                        cd['project'])
            text.append(u'<tr><td>Time:</td><td>%s</td></tr>' % when)
            text.append(u'<tr><td>Revision:</td><td>%s</td></tr>' %
                        cd['revision'])
            text.append(u'<tr><td>Changed by:</td><td>%s</td></tr>' %
                        cd['who'])
            text.append(u'<tr><td>Comments:</td><td>%s</td></tr>' %
                        "<br />".join(cd['comments'].split("\n")))

            files = cd['files']
            if files:
                text.append(u'<tr><td>Files:</td>')
                text.append(u'<td><table>')

                for file in files:
                    text.append(u'<tr><td>%s</td></tr>' % file['name'] )

                text.append(u'</table></td></tr>')

            text.append(u'</table>')
            text.append("<br />")
            i += 1

    text.append("<br />")

    # Last Buildstep Log
    if results != SUCCESS:
        logs = build.getLogs()

        for log in reversed(logs):
            if log.getName() == 'stdio':
                break

        name = u"%s.%s" % (log.getStep().getName(), log.getName())
        status, dummy = log.getStep().getResults()
        content = log.getText().splitlines()

        url = u'%s/steps/%s/logs/%s' % (master_status.getURLForThing(build),
                                        log.getStep().getName(),
                                        log.getName())

        text.append(u'<i>Build %s, detailed log of last build step: </i>' %
                    result)
        text.append(u'<br />')
        text.append(u'<a href="%s">%s</a>' % (url, url))
        text.append(u'<br />')
        text.append(u'<h5>Last %d lines of "%s"</h5>' % (MAIL_LOG_LAST_LINES,
                                                         name))

        unilist = list()
        for line in content[len(content)-MAIL_LOG_LAST_LINES:]:
            unilist.append(cgi.escape(unicode(line,'utf-8')))
        text.append(u'<pre>')
        text.extend(unilist)
        text.append(u'</pre>')

    # Signature
    text.append("<br /><br />")
    text.append("--")
    text.append("<br />")

    buildbot_url = master_status.getBuildbotURL()
    text.append("Debian NetEase Openstack packages auto-build")
    text.append("<br />")
    text.append("IRC: #debian-openstack-netease on OFTC (invite-only)")
    text.append("<br />")
    text.append("Web: <a href='%s'>%s</a>" % (buildbot_url, buildbot_url))

    return {
        'body': "\n".join(text),
        'type': 'html'
    }

mn = MailNotifier(fromaddr=MAIL_ADDR,
                  sendToInterestedUsers=False,
                  mode=("problem", "warnings"),
                  subject="[buildbot] %(result)s on %(builder)s",
                  addLogs=True,
                  addPatch=True,
                  extraRecipients=MAIL_RECIPIENTS,
                  relayhost=MAIL_SMTP_SERVER,
                  smtpPort=MAIL_SMTP_PORT,
                  useTls=MAIL_USE_TLS,
                  smtpUser=MAIL_USER,
                  smtpPassword=os.environ['BUILDBOT_MAIL_PASSWD'],
                  messageFormatter=messageFormatter,
                  extraHeaders={"Return-Path": "stan.zgy@gmail.com"})

c['status'].append(mn)


####### IRC BOT

from buildbot.status import words

irc = words.IRC('irc.oftc.net', 'openstack-netease',
                password=os.environ['BUILDBOT_IRC_NICK_PASSWD'],
                useColors=True,
                useRevisions=False,
                allowForce=True,
                channels=[{"channel": "#debian-openstack-netease"}],
                notify_events={
                    'started': 1,
                    'success': 1,
                    'failure': 1,
                    'exception': 1,
                    #'successToFailure': 1,
                    #'failureToSuccess': 1,
                })

c['status'].append(irc)
