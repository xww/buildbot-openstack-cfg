# -*- python -*-
# ex: set syntax=python:

import os
# This is a sample buildmaster config file. It must be installed as
# 'master.cfg' in your buildmaster's base directory.

# This is the dictionary that the buildmaster pays attention to. We also use
# a shorter alias to save typing.
c = BuildmasterConfig = {}

####### BUILDSLAVES

# The 'slaves' list defines the set of recognized buildslaves. Each element is
# a BuildSlave object, specifying a unique slave name and password.  The same
# slave name and password must be configured on the slave.
from buildbot.buildslave import BuildSlave
c['slaves'] = [BuildSlave("alice", "alice")]

slaves_env = {'havana': ['alice'], 'kilo': ['alice']}


# Setup slave build locks
from buildbot import locks

buildb_lock = locks.SlaveLock("slave_builds",
                              maxCount=1,
                              maxCountForSlave={'alice': 2})

# 'slavePortnum' defines the TCP port to listen on for connections from slaves.
# This must match the value configured into the buildslaves (with their
# --master option)
c['slavePortnum'] = 9989


# build options
BUILDBOT_WEB_ADDR = os.environ['BUILDBOT_WEB_ADDR']
BUILDBOT_WEB_PORT = int(os.environ['BUILDBOT_WEB_PORT'])

BUILDBOT_TITLE = 'NetEase Openstack'
BUILDBOT_TITLE_URL = os.environ['BUILDBOT_TITLE_URL']

BUILDER_PREFIX = 'build'
BUILDER_SRC_BRANCH = 'src'
BUILDER_DEBIAN_BRANCH = 'debian/autobuild'
BUILDER_EXPORT_DIR = 'build-area'

GERRIT_SERVER = os.environ['GERRIT_SERVER']
GERRIT_PORT = int(os.environ['GERRIT_PORT'])
GERRIT_USERNAME = os.environ['GERRIT_USERNAME']
GERRIT_PROJECT_PREFIX = 'openstack/'
GERRIT_REBUILD_WORD = 'rebuild'

REPREPRO_DIR = '/home/debian/reprepro'
ARCHIVE_DIR = '/home/debian/archive'
ARCHIVE_MODE = 0644

APTLY_URL = 'http://debian.163cloud.net:82/aptly'

DEFAULT_DIST = 'wheezy'
DEFAULT_ARCH = 'amd64'
PBUILDER_OPTIONS = '--allow-untrusted'
CLEANER = '/bin/true'
DEB_BUILD_OPTIONS = 'nocheck nodocs parallel=`nproc`'

MAIL_ADDR = os.environ['BUILDBOT_MAIL_ADDR']
MAIL_USER = os.environ['BUILDBOT_MAIL_USER']
MAIL_SMTP_SERVER = 'smtp.163.com'
MAIL_SMTP_PORT = 25
MAIL_USE_TLS = False
MAIL_RECIPIENTS = ["hzzhanggy@corp.netease.com"]
MAIL_RECIPIENTS.extend(["nvs@hz.netease.com", "cns@hz.netease.com"])
MAIL_LOG_LAST_LINES = 80

immediate_version = (r'git describe | '
                     r'sed -r "s/(.*)-(.*)-(.*)/\1+netease.\2.\3/"')
review_version = (r'git describe | '
                  r'sed -r "s/(.*)-(.*)-(.*)/\1+netease.\2/"')
nightly_version = (r'git describe | '
                   r'sed -r "s/(.*)-(.*)-(.*)/\1+netease.\2.\3.nightly/"')
release_version = r'git describe --tags --abbrev=0'


# build settings
class Env:
    ST = 'dev'
    IT = 'int'
    IT_OLD = 'int_old'
    RC = 'rc'
    RC_N = 'rc_n'
    RC_P = 'rc_p'
    REVIEW = 'review'


class Trigger:
    IMMEDIATE = 'immediate'
    NIGHTLY = 'nightly'
    RELEASE = 'release'


class ProjectType:
    NETEASE = 'ntes'
    OPENSTACK = 'os'


target_projects = {
    'kilo': {
        # Openstack projects
        'designate': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/designate.git',
                'code_branch': 'netease/kilo',
                'debian_branch': 'debian/kilo',
                'debian_repo': 'wheezy-kilo',
                'src_folder': 'designate',
                'aptly_repo': 'aptly-dev',
                'dist': 'kilo'
            },
            {
                'env': Env.REVIEW,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/designate.git',
                'code_branch': 'netease/kilo',
                'debian_branch': 'debian/kilo',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'designate',
                'dist': 'kilo'
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/designate.git',
                'code_branch': 'netease/kilo',
                'debian_branch': 'debian/kilo',
                'debian_repo': 'wheezy-kilo-testing',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'designate',
                'dist': 'kilo'
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/designate.git',
                'code_branch': 'netease/kilo-stable',
                'debian_branch': 'debian/kilo-stable',
                'debian_repo': 'wheezy-kilo-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'designate',
                'dist': 'kilo'
            },
            {
                'env': Env.RC_N,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/designate.git',
                'code_branch': 'netease/kilo-stable',
                'debian_branch': 'debian/kilo-stable',
                'debian_repo': 'wheezy-kilo-n-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'designate',
                'dist': 'kilo'
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/designate.git',
                'code_branch': 'netease/kilo-stable',
                'debian_branch': 'debian/kilo-stable',
                'debian_repo': 'wheezy-kilo-p-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'designate',
                'dist': 'kilo'
            },
        ],
    },
    'havana': {
        # Openstack projects
        'nova': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/nova.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'nova',
            },
            {
                'env': Env.REVIEW,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/nova.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'nova',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/nova.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-testing',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'nova',
            },
            {
                'env': Env.IT_OLD,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/nova.git',
                'code_branch': 'netease/havana-maint',
                'debian_branch': 'debian/havana-maint',
                'debian_repo': 'wheezy-havana-oldtesting',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'nova',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/nova.git',
                'code_branch': 'netease/havana-maint',
                'debian_branch': 'debian/havana-maint',
                'debian_repo': 'wheezy-havana-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'nova',
            },
            {
                'env': Env.RC_N,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/nova.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-n-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'nova',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/nova.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-p-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'nova',
            },
        ],
        'neutron': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/neutron.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'neutron',
            },
            {
                'env': Env.REVIEW,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/neutron.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'neutron',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/neutron.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-testing',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'neutron',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/neutron.git',
                'code_branch': 'netease/havana-release',
                'debian_branch': 'debian/havana-release',
                'debian_repo': 'wheezy-havana-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'neutron',
            },
            {
                'env': Env.RC_N,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/neutron.git',
                'code_branch': 'netease/havana-release',
                'debian_branch': 'debian/havana-release',
                'debian_repo': 'wheezy-havana-n-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'neutron',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/neutron.git',
                'code_branch': 'netease/havana-release',
                'debian_branch': 'debian/havana-release',
                'debian_repo': 'wheezy-havana-p-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'neutron',
            },
        ],
        'glance': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/glance.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'glance',
            },
            {
                'env': Env.REVIEW,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/glance.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'glance',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/glance.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-testing',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'glance',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/glance.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'glance',
            },
            {
                'env': Env.RC_N,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/glance.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-n-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'glance',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/glance.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-p-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'glance',
            },
        ],
        'keystone': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/keystone.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'keystone',
            },
            {
                'env': Env.REVIEW,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/keystone.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'keystone',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/keystone.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-testing',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'keystone',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/keystone.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'keystone',
            },
            {
                'env': Env.RC_N,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/keystone.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-n-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'keystone',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/keystone.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-p-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'keystone',
            },
        ],
        'cinder': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/cinder.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'cinder',
            },
            {
                'env': Env.REVIEW,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/cinder.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'cinder',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/cinder.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-testing',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'cinder',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/cinder.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'cinder',
            },
            {
                'env': Env.RC_N,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/cinder.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-n-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'cinder',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/cinder.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-p-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'cinder',
            },
        ],
        'python-novaclient': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-novaclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'aptly_repo': 'aptly-dev',
                'epoch': 2,
                'src_folder': 'python-novaclient',
            },
            {
                'env': Env.REVIEW,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-novaclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'python-novaclient',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-novaclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-testing',
                'aptly_repo': 'aptly-dev',
                'epoch': 2,
                'src_folder': 'python-novaclient',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-novaclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-rc',
                'aptly_repo': 'aptly-release',
                'epoch': 2,
                'src_folder': 'python-novaclient',
            },
            {
                'env': Env.RC_N,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-novaclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-n-rc',
                'aptly_repo': 'aptly-release',
                'epoch': 2,
                'src_folder': 'python-novaclient',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-novaclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-p-rc',
                'aptly_repo': 'aptly-release',
                'epoch': 2,
                'src_folder': 'python-novaclient',
            },
        ],
        'python-neutronclient': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-neutronclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'python-neutronclient',
            },
            {
                'env': Env.REVIEW,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-neutronclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'python-neutronclient',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-neutronclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-testing',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'python-neutronclient',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-neutronclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'python-neutronclient',
            },
            {
                'env': Env.RC_N,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-neutronclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-n-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'python-neutronclient',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-neutronclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-p-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'python-neutronclient',
            },
        ],
        'python-keystoneclient': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-keystoneclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'aptly_repo': 'aptly-dev',
                'epoch': 1,
                'src_folder': 'python-keystoneclient',
            },
            {
                'env': Env.REVIEW,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-keystoneclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'python-keystoneclient',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-keystoneclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-testing',
                'aptly_repo': 'aptly-dev',
                'epoch': 1,
                'src_folder': 'python-keystoneclient',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-keystoneclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-rc',
                'aptly_repo': 'aptly-release',
                'epoch': 1,
                'src_folder': 'python-keystoneclient',
            },
            {
                'env': Env.RC_N,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-keystoneclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-n-rc',
                'aptly_repo': 'aptly-release',
                'epoch': 1,
                'src_folder': 'python-keystoneclient',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-keystoneclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-p-rc',
                'aptly_repo': 'aptly-release',
                'epoch': 1,
                'src_folder': 'python-keystoneclient',
            },
        ],
        'python-cinderclient': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-cinderclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'aptly_repo': 'aptly-dev',
                'epoch': 1,
                'src_folder': 'python-cinderclient',
            },
            {
                'env': Env.REVIEW,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-cinderclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'python-cinderclient',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-cinderclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-testing',
                'aptly_repo': 'aptly-dev',
                'epoch': 1,
                'src_folder': 'python-cinderclient',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-cinderclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-rc',
                'aptly_repo': 'aptly-release',
                'epoch': 1,
                'src_folder': 'python-cinderclient',
            },
            {
                'env': Env.RC_N,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-cinderclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-n-rc',
                'aptly_repo': 'aptly-release',
                'epoch': 1,
                'src_folder': 'python-cinderclient',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.OPENSTACK,
                'repo_url': 'ssh://SCM/openstack/python-cinderclient.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-p-rc',
                'aptly_repo': 'aptly-release',
                'epoch': 1,
                'src_folder': 'python-cinderclient',
            },
        ],

        # NetEase projects
        'umbrella': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/umbrella.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'umbrella',
            },
            {
                'env': Env.REVIEW,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/umbrella.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'umbrella',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/umbrella.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-testing',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'umbrella',
            },
            {
                'env': Env.IT_OLD,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/umbrella.git',
                'code_branch': 'netease/havana-maint',
                'debian_branch': 'debian/havana-maint',
                'debian_repo': 'wheezy-havana-oldtesting',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'umbrella',
            },
            {
                'env': Env.RC,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/umbrella.git',
                'code_branch': 'netease/havana-maint',
                'debian_branch': 'debian/havana-maint',
                'debian_repo': 'wheezy-havana-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'umbrella',
            },
            {
                'env': Env.RC_N,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/umbrella.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-n-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'umbrella',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/umbrella.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-p-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'umbrella',
            },
        ],
        'monitor': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/monitor.git',
                'code_branch': 'master',
                'debian_branch': 'debian/netease',
                'debian_repo': 'wheezy-havana-dev',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'monitor',
            },
            {
                'env': Env.REVIEW,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/monitor.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'monitor',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/monitor.git',
                'code_branch': 'stable',
                'debian_branch': 'debian/netease-stable',
                'debian_repo': 'wheezy-havana-testing',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'monitor',
            },
            {
                'env': Env.RC_N,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/monitor.git',
                'code_branch': 'stable',
                'debian_branch': 'debian/netease-stable',
                'debian_repo': 'wheezy-havana-n-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'monitor',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/monitor.git',
                'code_branch': 'stable',
                'debian_branch': 'debian/netease-stable',
                'debian_repo': 'wheezy-havana-p-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'monitor',
            },
        ],
        'sentry': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/sentry.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'sentry',
            },
            {
                'env': Env.REVIEW,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/sentry.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'sentry',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/sentry.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-testing',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'sentry',
            },
            {
                'env': Env.RC_N,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/sentry.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-n-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'sentry',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/sentry.git',
                'code_branch': 'netease/havana-stable',
                'debian_branch': 'debian/havana-stable',
                'debian_repo': 'wheezy-havana-p-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'sentry',
            },
        ],
        'neutron-inspect': [
            {
                'env': Env.ST,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/neutron-inspect.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-dev',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'neutron-inspect',
            },
            {
                'env': Env.REVIEW,
                'trigger': Trigger.IMMEDIATE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/neutron-inspect.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'neutron-inspect',
            },
            {
                'env': Env.IT,
                'trigger': Trigger.NIGHTLY,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/neutron-inspect.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-testing',
                'aptly_repo': 'aptly-dev',
                'src_folder': 'neutron-inspect',
            },
            {
                'env': Env.RC_N,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/neutron-inspect.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-n-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'neutron-inspect',
            },
            {
                'env': Env.RC_P,
                'trigger': Trigger.RELEASE,
                'project_type': ProjectType.NETEASE,
                'repo_url': 'ssh://SCM/openstack/neutron-inspect.git',
                'code_branch': 'netease/havana',
                'debian_branch': 'debian/havana',
                'debian_repo': 'wheezy-havana-p-rc',
                'aptly_repo': 'aptly-release',
                'src_folder': 'neutron-inspect',
            },
        ],
    },
}


####### CHANGESOURCES

# the 'change_source' setting tells the buildmaster how it should find out
# about source code changes.  Here we point to the buildbot clone of pyflakes.
from buildbot.changes.gitpoller import GitPoller
from buildbot.changes.gerritchangesource import GerritChangeSource

c['change_source'] = []

# Openstack projects
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/nova.git',
    workdir='nova',
    project='nova',
    branches=['netease/havana', 'netease/havana-stable',
              'netease/havana-maint'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/neutron.git',
    workdir='neutron',
    project='neutron',
    branches=['netease/havana', 'netease/havana-stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/glance.git',
    workdir='glance',
    project='glance',
    branches=['netease/havana', 'netease/havana-stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/keystone.git',
    workdir='keystone',
    project='keystone',
    branches=['netease/havana', 'netease/havana-stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/cinder.git',
    workdir='cinder',
    project='cinder',
    branches=['netease/havana', 'netease/havana-stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/designate.git',
    workdir='designate',
    project='designate',
    branches=['netease/kilo', 'netease/kilo-stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/python-novaclient.git',
    workdir='python-novaclient',
    project='python-novaclient',
    branches=['netease/master', 'netease/havana'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/python-glanceclient.git',
    workdir='python-glanceclient',
    project='python-glanceclient',
    branches=['netease/master', 'netease/havana'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/python-keystoneclient.git',
    workdir='python-keystoneclient',
    project='python-keystoneclient',
    branches=['netease/master', 'netease/havana'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/python-neutronclient.git',
    workdir='python-neutronclient',
    project='python-neutronclient',
    branches=['netease/master', 'netease/havana'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/python-cinderclient.git',
    workdir='python-cinderclient',
    project='python-cinderclient',
    branches=['netease/master', 'netease/havana'],
    pollinterval=300))

# NetEase projects
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/billing.git',
    workdir='billing',
    project='billing',
    branches=['master', 'stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/sentry.git',
    workdir='sentry',
    project='sentry',
    branches=['netease/havana', 'netease/havana-stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/umbrella.git',
    workdir='umbrella',
    project='umbrella',
    branches=['netease/havana', 'netease/havana-stable',
              'netease/havana-maint'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/monitor.git',
    workdir='monitor',
    project='monitor',
    branches=['master', 'stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/python-nosclient.git',
    workdir='python-nosclient',
    project='python-nosclient',
    branches=['master', 'stable'],
    pollinterval=300))
c['change_source'].append(GitPoller(
    'ssh://SCM/openstack/neutron-inspect.git',
    workdir='neutron-inspect',
    project='neutron-inspect',
    branches=['netease/havana'],
    pollinterval=300))
c['change_source'].append(GerritChangeSource(
    gerritserver=GERRIT_SERVER,
    gerritport=GERRIT_PORT,
    username=GERRIT_USERNAME,
    handled_events=['patchset-created', 'comment-added']))


####### SCHEDULERS

import re

from buildbot.schedulers.basic import SingleBranchScheduler
from buildbot.schedulers.timed import Nightly
from buildbot.schedulers.forcesched import ForceScheduler
from buildbot.scheduler import Try_Userpass
from buildbot.changes import filter as changes_filter


def change_comment_rebuild(change):
    properties = change.properties

    if not ('event.type' in properties and
            properties['event.type'] == 'comment-added'):
        return False

    if 'event.comment' in change.properties:
        pattern = re.compile('[\s\S]*%s$' % GERRIT_REBUILD_WORD)
        if pattern.match(change.properties['event.comment']):
            return True
    return False


def change_patchset_added(change):
    properties = change.properties

    if (('event.type' in properties and
         properties['event.type'] == 'patchset-created')):
        return True
    return False


def add_scheduler(c, project, branch, codename, env):
    import random

    m = random.randint(0, 59)
    if env == Env.ST:
        c['schedulers'].append(SingleBranchScheduler(
            name='-'.join([project, codename, env]),
            change_filter=changes_filter.ChangeFilter(
                project=project,
                branch=branch),
            builderNames=[
                '-'.join([BUILDER_PREFIX, project,
                          codename, env])],
            treeStableTimer=120))
        c['schedulers'].append(ForceScheduler(
            name='-'.join([project, codename,
                           'force', env]),
            builderNames=[
                '-'.join([BUILDER_PREFIX, project,
                          codename, env])]))
    elif env in (Env.IT, Env.IT_OLD):
        c['schedulers'].append(Nightly(
            name='-'.join([project, codename, env]),
            branch=branch,
            change_filter=changes_filter.ChangeFilter(
                project=project,
                branch=branch),
            builderNames=[
                '-'.join([BUILDER_PREFIX, project,
                          codename, env])],
            hour=2,
            minute=m,
            onlyIfChanged=True))
        c['schedulers'].append(ForceScheduler(
            name='-'.join([project, codename,
                           'force', env]),
            builderNames=[
                '-'.join([BUILDER_PREFIX, project,
                          codename, env])]))
    elif env in (Env.RC, Env.RC_N, Env.RC_P):
        c['schedulers'].append(ForceScheduler(
            name='-'.join([project, codename,
                           'force', env]),
            builderNames=[
                '-'.join([BUILDER_PREFIX, project,
                          codename, env])]))
    elif env == Env.REVIEW:
        c['schedulers'].append(SingleBranchScheduler(
            name='-'.join([project, codename, env]),
            change_filter=changes_filter.ChangeFilter(
                project=GERRIT_PROJECT_PREFIX+project,
                branch_re=("(^%s$)|(^%s/\w+).*" % (branch, branch)),
                filter_fn=change_patchset_added),
            builderNames=[
                '-'.join([BUILDER_PREFIX, project,
                          codename, env])],
            treeStableTimer=30))
        c['schedulers'].append(SingleBranchScheduler(
            name='-'.join([project, codename, env, 'rebuild']),
            change_filter=changes_filter.ChangeFilter(
                project=GERRIT_PROJECT_PREFIX+project,
                branch_re=("(^%s$)|(^%s/\w+).*" % (branch, branch)),
                filter_fn=change_comment_rebuild),
            builderNames=[
                '-'.join([BUILDER_PREFIX, project,
                          codename, env])],
            treeStableTimer=10))
    else:
        raise Exception("undefined environment")


# add schedulers
c['schedulers'] = []

for codename, targets in target_projects.iteritems():
    for project, builds in targets.iteritems():
        for build in builds:
            add_scheduler(c, project, build['code_branch'],
                          codename, build['env'])


####### BUILDERS

from buildbot.process.factory import BuildFactory
from buildbot.process.properties import Interpolate
from buildbot.process.properties import Property
from buildbot.steps.master import MasterShellCommand
from buildbot.steps.master import SetProperty
from buildbot.steps.shell import SetPropertyFromCommand
from buildbot.steps.shell import ShellCommand
from buildbot.steps.source.git import Git
from buildbot.steps.source.gerrit import Gerrit
from buildbot.steps.transfer import FileUpload


# init build factories
for codename, targets in target_projects.iteritems():
    for project, builds in targets.iteritems():
        for build in builds:
            locals()['_'.join([project, codename,
                               build['env'], 'factory'])] = BuildFactory()


# check if new package version is duped
def isVersionNotDupe(step):
    allSteps = step.build.getStatus().getSteps()
    repoVersionStep = filter(lambda x: x.getName() ==
                             "Check repo existed package version",
                             allSteps)
    if not repoVersionStep:
        return True

    logText = repoVersionStep[0].getLogs()[0].getText()

    if len(logText):
        return True
    else:
        return False


# define build steps
def add_build_step(factory, build_kwargs):
    # init build args
    project = build_kwargs['project']
    codename = build_kwargs['codename']
    repo_url = build_kwargs['repo_url']
    env = build_kwargs['env']
    trigger = build_kwargs['trigger']
    code_branch = build_kwargs['code_branch']
    debian_branch = build_kwargs['debian_branch']
    debian_repo = build_kwargs['debian_repo']
    aptly_repo = build_kwargs['aptly_repo']
    upstream_version = build_kwargs['upstream_version']
    debian_version = build_kwargs['debian_version']
    epoch = build_kwargs['epoch']
    dist = build_kwargs['dist']
    arch = build_kwargs['arch']

    # clone git repo
    if env == Env.REVIEW:
        factory.addStep(Gerrit(repourl=repo_url,
                               mode='full', method='clobber',
                               workdir='build/%s' % project,
                               progress=False,
                               retryFetch=True,
                               haltOnFailure=True,
                               logEnviron=False))
    else:
        factory.addStep(Git(repourl=repo_url,
                            mode='full', method='clobber',
                            workdir='build/%s' % project,
                            progress=False,
                            retryFetch=True,
                            haltOnFailure=True,
                            logEnviron=False))

    # make sure remote code branch and debian branch are correct
    factory.addStep(ShellCommand(
        name='Ensure debian branch',
        command=['git', 'checkout', 'origin/%s' % debian_branch],
        haltOnFailure=True,
        workdir='build/%s' % project,
        logEnviron=False))

    if env == Env.REVIEW:
        factory.addStep(ShellCommand(
            name='Ensure src branch',
            command=['git', 'checkout', '-b', BUILDER_SRC_BRANCH, '@{-1}'],
            haltOnFailure=True,
            workdir='build/%s' % project,
            logEnviron=False))
        factory.addStep(ShellCommand(
            name='Tag patchset version',
            command=(Interpolate('git tag $(' + upstream_version + ')'
                                 '.r%(prop:event.change.number)s.'
                                 '%(prop:event.patchSet.number)s')),
            haltOnFailure=True,
            workdir='build/%s' % project,
            logEnviron=False))
    else:
        factory.addStep(ShellCommand(
            name='Ensure src branch',
            command=['git', 'checkout', 'origin/%s' % code_branch],
            haltOnFailure=True,
            workdir='build/%s' % project,
            logEnviron=False))
        factory.addStep(ShellCommand(
            name='Checkout src local branch',
            command=('git checkout -b %(src_branch)s $(%(version)s) || '
                     '(git checkout -b %(src_branch)s origin/%(code_branch)s && '
                     'git tag $(%(version)s))' %
                        {'src_branch': BUILDER_SRC_BRANCH,
                         'version': upstream_version,
                         'code_branch': code_branch}),
            haltOnFailure=True,
            workdir='build/%s' % project,
            logEnviron=False))

    # prepare local debian build branch
    factory.addStep(SetPropertyFromCommand(
        command=['git', 'describe', '--tags'],
        property='git_version',
        workdir='build/%s' % project,
        logEnviron=False))
    factory.addStep(ShellCommand(
        name='Checkout debian local branch',
        command=['git', 'checkout', '-b',
                 BUILDER_DEBIAN_BRANCH, 'origin/%s' % debian_branch],
        workdir='build/%s' % project,
        logEnviron=False))
    factory.addStep(ShellCommand(
        name='Merge src branch with debian branch',
        command=['git', 'merge',
                 BUILDER_SRC_BRANCH,
                 '--no-edit', '--stat'],
        haltOnFailure=True,
        workdir='build/%s' % project,
        logEnviron=False))

    # generate changelog
    e = ''
    if epoch:
        e = str(epoch) + ':'

    factory.addStep(ShellCommand(
        name='Generate debian changelog',
        command=['git', 'dch',
                 '--debian-branch', BUILDER_DEBIAN_BRANCH,
                 '--git-author',
                 '--new-version', Interpolate(e + '%(prop:git_version)s-' +
                                              debian_version)],
        workdir='build/%s' % project,
        warnOnWarnings=True,
        haltOnFailure=True,
        logEnviron=False))

    repo = 'UNRELEASED'
    if aptly_repo:
        repo = aptly_repo
        factory.addStep(SetProperty(property='aptly_repo', value=aptly_repo))
    if debian_repo:
        repo = debian_repo
        factory.addStep(SetProperty(property='debian_repo', value=debian_repo))

    factory.addStep(ShellCommand(
        name='Update changelog release repo',
        command=['sed', '-i',
                 's/UNRELEASED/'+repo+'/',
                 'debian/changelog'],
        workdir='build/%s' % project,
        logEnviron=False))
    factory.addStep(ShellCommand(
        name='Commit changes for packaging',
        command=['git', 'commit', '-a', '-m', 'buildbot auto build'],
        workdir='build/%s' % project,
        logEnviron=False))

    # clean build export folder
    factory.addStep(ShellCommand(
        name='Clean build export folder',
        command='rm -rf *',
        workdir='build/%s' % BUILDER_EXPORT_DIR,
        logEnviron=False))

    # build the package
    factory.addStep(ShellCommand(
        name='Update pbuilder apt source',
        command=['git-pbuilder', 'update'],
        env={'DIST': dist, 'ARCH': arch},
        workdir='build/%s' % project,
        haltOnFailure=True,
        logEnviron=False))
    factory.addStep(ShellCommand(
        name='Build all packages!',
        command=['git-buildpackage',
                 '--git-dist=%s' % dist,
                 '--git-arch=%s' % arch,
                 '--git-pbuilder',
                 '--git-pbuilder-options=%s' % PBUILDER_OPTIONS,
                 '--git-cleaner=%s' % CLEANER,
                 '--git-upstream-branch=%s' % BUILDER_SRC_BRANCH,
                 '--git-debian-branch=%s' % BUILDER_DEBIAN_BRANCH,
                 '--git-upstream-tree=branch',
                 '--git-export-dir=../%s' % BUILDER_EXPORT_DIR,
                 '--git-force-create',
                 '-nc'],
        env={'DEB_BUILD_OPTIONS': DEB_BUILD_OPTIONS},
        workdir='build/%s' % project,
        haltOnFailure=True,
        warnOnWarnings=True,
        logEnviron=False))

    # get package version
    factory.addStep(SetPropertyFromCommand(
        command=(r'head -n 1 debian/changelog | sed -r "s/.+\((.+)\).+/\1/"'),
        property='package_version_epoch',
        workdir='build/%s' % project,
        logEnviron=False))
    factory.addStep(SetPropertyFromCommand(
        command=(r'head -n 1 debian/changelog | sed -r "s/.+\((.+)\).+/\1/" | '
                 r'sed  "s/.*\://g"'),
        property='package_version',
        workdir='build/%s' % project,
        logEnviron=False))

    factory.addStep(SetPropertyFromCommand(
        command=(r'ls -1 *.deb|sed -r "s/(.*)_.*_.*/    \1/"'),
        property='package_list',
        workdir='build/%s' % BUILDER_EXPORT_DIR,
        logEnviron=False))

    # check if repo package version duped
    if debian_repo:
        vcp = ("/bin/bash -c 'diff <(echo %(version)s) "
               "<(reprepro listmatched %(debian_repo)s %(project)s|"
               "grep source|cut -d\" \" -f3)||true'" %
               {'debian_repo': debian_repo,
                'project': project,
                'version': '%(prop:package_version_epoch)s'})
        factory.addStep(MasterShellCommand(
            name="Check repo existed package version",
            command=Interpolate(vcp),
            haltOnFailure=False,
            env={'REPREPRO_BASE_DIR': REPREPRO_DIR}))

    factory.addStep(ShellCommand(
        name='Prepare to upload packages',
        command=['/bin/sh', '-c',
                 Interpolate('tar cJf %(project)s_%(version)s.tar.xz '
                             '--exclude=%(project)s_%(version)s.tar.xz '
                             '*%(git_version)s*' %
                             {'project': project,
                              'version': '%(prop:package_version)s',
                              'git_version': '%(prop:git_version)s'})],
        workdir='build/%s' % BUILDER_EXPORT_DIR,
        doStepIf=isVersionNotDupe,
        haltOnFailure=True,
        logEnviron=False))

    # upload archive to master
    factory.addStep(FileUpload(
        slavesrc=Interpolate('%(project)s_%(version)s.tar.xz' %
                             {'project': project,
                              'version': '%(prop:package_version)s'}),
        masterdest=(Interpolate(ARCHIVE_DIR+'/%(env)s/%(project)s/%(version)s/'
                                '%(project)s_%(version)s.tar.xz' %
                                {'env': env,
                                 'project': project,
                                 'trigger': trigger,
                                 'version': '%(prop:package_version)s'})),
        mode=ARCHIVE_MODE,
        doStepIf=isVersionNotDupe,
        workdir='build/%s' % BUILDER_EXPORT_DIR))

    # add package to deb source
    if debian_repo:
        msc = []
        msc.append('cd %(archive_dir)s/%(env)s/%(project)s/%(version)s')
        msc.append('tar xJf %(project)s_%(version)s.tar.xz')
        msc.append('reprepro -b %(reprepro_dir)s '
                   '--ignore=wrongdistribution --ignore=missingfile '
                   'include %(debian_repo)s *%(version)s*.changes')
        msc = '\n'.join(msc) % {'project': project,
                                'env': env,
                                'version': '%(prop:package_version)s',
                                'reprepro_dir': REPREPRO_DIR,
                                'archive_dir': ARCHIVE_DIR,
                                'debian_repo': debian_repo}
        factory.addStep(MasterShellCommand(
            name='Import packages with reprepro',
            command=Interpolate(msc),
            doStepIf=isVersionNotDupe,
            haltOnFailure=False,
            env={}))

    if aptly_repo:
        msc = []
        msc.append('cd %(archive_dir)s/%(env)s/%(project)s/%(version)s')
        msc.append('tar xJf %(project)s_%(version)s.tar.xz')
        msc.append('aptly repo remove %(aptly_repo)s '
                   '\'$Source (%(project)s), $Version (=%(version)s)\'')
        msc.append('aptly repo add %(aptly_repo)s *.deb')
        msc.append('aptly publish update -skip-signing=true '
                   '-force-overwrite=true %(aptly_repo)s')
        msc = '\n'.join(msc) % {'project': project,
                                'env': env,
                                'version': '%(prop:package_version)s',
                                'archive_dir': ARCHIVE_DIR,
                                'aptly_repo': aptly_repo}
        factory.addStep(MasterShellCommand(
            name='Import packages with aptly',
            command=Interpolate(msc),
            doStepIf=isVersionNotDupe,
            haltOnFailure=False,
            env={'PATH': ['/usr/local/bin', '/usr/bin', '/bin', '${PATH}']}))


# add builder factory buildsteps
for codename, targets in target_projects.iteritems():
    for project, builds in targets.iteritems():
        for build in builds:
            build_kwargs = {
                'project': project,
                'codename': codename,
                'repo_url': build['repo_url'],
                'env': build['env'],
                'trigger': build['trigger'],
                'code_branch': build['code_branch'],
                'debian_branch': build['debian_branch'],
                'debian_repo': build.get('debian_repo', None),
                'aptly_repo': build.get('aptly_repo', None),
            }

            if build['trigger'] == Trigger.IMMEDIATE:
                upstream_version = immediate_version
            elif build['trigger'] == Trigger.NIGHTLY:
                upstream_version = nightly_version
            elif build['trigger'] == Trigger.RELEASE:
                upstream_version = release_version
            else:
                raise Exception("undefined trigger")

            if build['env'] == Env.REVIEW:
                upstream_version = review_version

            epoch = build.get('epoch')
            if epoch:
                epoch = epoch

            debian_version = build.get('debian_version')
            if debian_version:
                debian_version = debian_version
            else:
                debian_version = '1'

            build_kwargs['upstream_version'] = upstream_version
            build_kwargs['debian_version'] = debian_version
            build_kwargs['epoch'] = epoch

            dist = build.get('dist')
            if dist:
                build_kwargs['dist'] = dist
            else:
                build_kwargs['dist'] = DEFAULT_DIST

            arch = build.get('arch')
            if arch:
                build_kwargs['arch'] = arch
            else:
                build_kwargs['arch'] = DEFAULT_ARCH

            add_build_step(factory=locals()['_'.join([project,
                                                      codename,
                                                      build['env'],
                                                      'factory'])],
                           build_kwargs=build_kwargs)


# init builder configs
from buildbot.config import BuilderConfig

c['builders'] = []
for codename, targets in target_projects.iteritems():
    for project, builds in targets.iteritems():
        for build in builds:
            c['builders'].append(
                BuilderConfig(
                    name='-'.join([BUILDER_PREFIX, project,
                                   codename, build['env']]),
                    slavenames=slaves_env[codename],
                    factory=locals()['_'.join([project, codename,
                                               build['env'], 'factory'])],
                    locks=[buildb_lock.access('counting')]))


####### STATUS TARGETS

# 'status' is a list of Status Targets. The results of each build will be
# pushed to these targets. buildbot/status/*.py has a variety to choose from,
# including web pages, email senders, and IRC bots.

c['status'] = []

from buildbot.status import html
from buildbot.status.web import authz, auth

authz_cfg = authz.Authz(
    # change any of these to True to enable; see the manual for more
    # options
    auth=auth.BasicAuth([("admin", os.environ['BUILDBOT_ADMIN_PASSWD'])]),
    gracefulShutdown=True,
    forceBuild=False,
    forceAllBuilds=False,
    pingBuilder=True,
    stopBuild=True,
    stopAllBuilds=False,
    cancelPendingBuild=True,
)
c['status'].append(html.WebStatus(http_port=BUILDBOT_WEB_PORT,
                                  authz=authz_cfg))


####### PROJECT IDENTITY

# the 'title' string will appear at the top of this buildbot
# installation's html.WebStatus home page (linked to the

c['title'] = BUILDBOT_TITLE
c['titleURL'] = BUILDBOT_TITLE_URL

# the 'buildbotURL' string should point to the location where the buildbot's
# internal web server (usually the html.WebStatus page) is visible. This
# typically uses the port number set in the Waterfall 'status' entry, but
# with an externally-visible host name which the buildbot cannot figure out
# without some help.

c['buildbotURL'] = ("http://%(server)s:%(port)d/" %
                    {'server': BUILDBOT_WEB_ADDR,
                     'port': BUILDBOT_WEB_PORT})


####### DB URL

c['db'] = {
    # This specifies what database buildbot uses to store its state.
    # You can leave this at its default for all but the largest installations.
    'db_url': "sqlite:///state.sqlite",
}


####### MAIL NOTIFIER

import cgi
import datetime

from buildbot.status.mail import MailNotifier
from buildbot.status.builder import Results
from buildbot.status.results import SUCCESS


def messageFormatter(mode, name, build, results, master_status):
    result = Results[results]

    # Build Info
    text = list()
    text.append(u"<h4>Build status: %s</h4>" % result.title())
    text.append(u'<table cellspacing="10">')
    text.append(u"<tr><td>Build reason:</td><td>%s</td></tr>" %
                cgi.escape(build.getReason()))
    text.append(u"<tr><td>Buildslave for this build:</td><td>%s</td></tr>" %
                build.getSlavename())

    responsible_users = ",".join(build.getResponsibleUsers())
    if responsible_users:
        text.append(u"<tr><td>Build Responsible Users:</td><td>%s</td></tr>" %
                    cgi.escape(responsible_users))

    for ss in build.getSourceStamps():
        source = u""
        if ss.codebase:
            source += u'%s: ' % ss.codebase
        if ss.branch:
            source += u"[branch %s] " % ss.branch
        if ss.revision:
            source += ss.revision
        else:
            source += u"HEAD"
        if ss.patch:
            source += u" (plus patch)"
        if ss.patch_info:  # add patch comment
            source += u" (%s)" % ss.patch_info[1]

    text.append(u"<tr><td>Build Source Stamp:</td><td>%s</td></tr>" % source)

    build_url = master_status.getURLForThing(build)
    if build_url:
        text.append(u"<tr><td>Complete logs for build steps:</td>"
                    "<td><a href='%s'>%s</a></td></tr>" %
                    (build_url, build_url))

    text.append(u'</table>')
    text.append("<br />")

    # Recent Changes
    if ss.changes:
        i = 1
        text.append(u'<h4>Recent Changes:</h4>')
        for c in ss.changes:
            cd = c.asDict()
            when = datetime.datetime.fromtimestamp(cd['when']).ctime()

            text.append(u'<h5>change #%d</h5>' % i)
            text.append(u'<table cellspacing="10">')
            text.append(u'<tr><td>Repository:</td><td>%s</td></tr>' %
                        cd['repository'])
            text.append(u'<tr><td>Project:</td><td>%s</td></tr>' %
                        cd['project'])
            text.append(u'<tr><td>Time:</td><td>%s</td></tr>' % when)
            text.append(u'<tr><td>Revision:</td><td>%s</td></tr>' %
                        cd['revision'])
            text.append(u'<tr><td>Changed by:</td><td>%s</td></tr>' %
                        cd['who'])
            text.append(u'<tr><td>Comments:</td><td>%s</td></tr>' %
                        "<br />".join(cd['comments'].split("\n")))

            files = cd['files']
            if files:
                text.append(u'<tr><td>Files:</td>')
                text.append(u'<td><table>')

                for file in files:
                    text.append(u'<tr><td>%s</td></tr>' % file['name'])

                text.append(u'</table></td></tr>')

            text.append(u'</table>')
            text.append("<br />")
            i += 1

    text.append("<br />")

    # Last Buildstep Log
    if results != SUCCESS:
        logs = build.getLogs()

        for log in reversed(logs):
            if log.getName() == 'stdio':
                break

        name = u"%s.%s" % (log.getStep().getName(), log.getName())
        status, dummy = log.getStep().getResults()
        content = log.getText().splitlines()

        url = u'%s/steps/%s/logs/%s' % (master_status.getURLForThing(build),
                                        log.getStep().getName(),
                                        log.getName())

        text.append(u'<i>Build %s, detailed log of last build step: </i>' %
                    result)
        text.append(u'<br />')
        text.append(u'<a href="%s">%s</a>' % (url, url))
        text.append(u'<br />')
        text.append(u'<h5>Last %d lines of "%s"</h5>' % (MAIL_LOG_LAST_LINES,
                                                         name))

        unilist = list()
        for line in content[len(content)-MAIL_LOG_LAST_LINES:]:
            unilist.append(cgi.escape(unicode(line, 'utf-8')))
        text.append(u'<pre>')
        text.extend(unilist)
        text.append(u'</pre>')

    # Signature
    text.append("<br /><br />")
    text.append("--")
    text.append("<br />")

    buildbot_url = master_status.getBuildbotURL()
    text.append("Debian NetEase Openstack packages auto-build")
    text.append("<br />")
    text.append("IRC: #debian-openstack-netease on OFTC (invite-only)")
    text.append("<br />")
    text.append("Web: <a href='%s'>%s</a>" % (buildbot_url, buildbot_url))

    return {
        'body': "\n".join(text),
        'type': 'html'
    }

mn = MailNotifier(fromaddr=MAIL_ADDR,
                  sendToInterestedUsers=False,
                  mode=("problem", "warnings"),
                  subject="[buildbot] %(result)s on %(builder)s",
                  addLogs=True,
                  addPatch=True,
                  extraRecipients=MAIL_RECIPIENTS,
                  relayhost=MAIL_SMTP_SERVER,
                  smtpPort=MAIL_SMTP_PORT,
                  useTls=MAIL_USE_TLS,
                  smtpUser=MAIL_USER,
                  smtpPassword=os.environ['BUILDBOT_MAIL_PASSWD'],
                  messageFormatter=messageFormatter,
                  extraHeaders={"Return-Path": "stan.zgy@gmail.com"})

c['status'].append(mn)


####### IRC BOT

from buildbot.status import words

irc = words.IRC('irc.oftc.net', 'openstack-netease',
                password=os.environ['BUILDBOT_IRC_NICK_PASSWD'],
                useColors=True,
                useRevisions=False,
                allowForce=True,
                channels=[{"channel": "#debian-openstack-netease"}],
                notify_events={
                    'started': 1,
                    'success': 1,
                    'failure': 1,
                    'exception': 1,
                    #'successToFailure': 1,
                    #'failureToSuccess': 1,
                })

c['status'].append(irc)


####### GERRIT BOT

from buildbot.status.status_gerrit import GerritStatusPush

def gerritStartCB(name, build, arg):
    text = list()
    text.append(u'Starting patchset debianizing jobs. %s:%s' %
                (BUILDBOT_TITLE_URL, BUILDBOT_WEB_PORT))
    result = '\n'.join(text)
    return result

def gerritReviewCB(name, build, result, status, arg):
    current_build = build.getBuilder().getBuild(build.getNumber())
    properties = current_build.getProperties().asDict() or {}
    aptly_repo = properties.get('aptly_repo', None)
    version = properties.get('package_version_epoch', None)
    package_list = properties.get('package_list', None)
    build_url = status.getURLForThing(build)

    if aptly_repo:
        aptly_repo = aptly_repo[0]
    if version:
        version = version[0]
    if package_list:
        package_list = package_list[0]
        package_list = '    ' + package_list

    text = list()
    reviewed = 0
    verified = 0
    if result != SUCCESS:
        text.append(u'Failed to debianize your patchset.')
        text.append(u'\n')
        text.append(u'Details: %s' % build_url)
        reviewed = -1
    else:
        text.append(u'Finished debianizing your patchset.')
        text.append(u'\n')
        text.append(u'To Try this patchset with Debian, add following source '
                    'to your /etc/apt/sources.list')
        text.append(u'\n')
        text.append(u'    deb %s %s main' % (APTLY_URL, aptly_repo))
        text.append(u'\n')
        text.append(u'Then install packages you want with root privilege:')
        text.append(u'\n')
        text.append(u'    $ aptitude update' )
        text.append(u'    $ aptitude install $PACKAGE_NAME=%s' % str(version))
        text.append(u'\n')
        text.append(u'$PACKAGE_NAME candidates:')
        text.append(u'\n')
        text.append(u'%s' % package_list)
        reviewed = 1

    message = '\n'.join(text)
    return message, verified, reviewed

gsp = GerritStatusPush(GERRIT_SERVER, GERRIT_USERNAME,
                       port=GERRIT_PORT,
                       reviewCB=gerritReviewCB,
                       startCB=gerritStartCB)

c['status'].append(gsp)
